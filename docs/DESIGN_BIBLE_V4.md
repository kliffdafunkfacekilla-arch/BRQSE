# THE CHAOS ENGINE: DESIGN BIBLE (V4.0)

> **Core Philosophy:** "The Engine simulates the physics; The AI directs the movie."
> 
> **Loop:** Tavern → Node Map → The Scene Stack → Tavern.

---

## I. COMBAT MECHANICS (The Physics)

Combat is deterministic and brutal. Every action is an opposed roll.

### 1. The Core Roll

**Attack:** `d20 + Weapon Skill + Attribute Mod`
- Example: Great Weapons (Skill) + Might (Stat).

**Defense:** `d20 + Armor Skill + Attribute Mod`
- Example: Plate (Skill) + Endurance (Stat).

**The Margin:** `Attack Total - Defense Total`
- **Positive (+5 to +9):** Solid Hit (Full HP Damage).
- **Negative:** Miss or Counter-Opportunity.
- **Tie (0):** THE CLASH.

### 2. The Clash System (The Duel)

Triggered when Margin is exactly 0. Time slows. Both parties secretly choose a tactic:

**Option A: PRESS (Aggressive)**
- Uses your Weapon Skill's Attribute (e.g., Might for Greatswords).

**Option B: DISENGAGE (Defensive)**
- Uses your Armor Skill's Attribute (e.g., Endurance for Plate).

**Resolution:**
The winner is the one with the higher Stat Score (Passive Check).
- **Winner:** Staggers the loser.
- **Loser:** Suffers a specific physics effect based on the Winner's Stat:

| Winner's Stat | The Physics Effect |
|---------------|-------------------|
| MIGHT | **Overpower:** Winner advances 1 step; Loser pushed back 1 step. |
| FINESSE | **Disarm:** Loser drops their active weapon. |
| REFLEX | **Redirect:** Winner swaps spaces with Loser and chooses facing. |
| VITALITY | **Exhaust:** Loser takes Composure Damage. |
| FORTITUDE | **Bulwark:** Loser pulled forward 1 step; Winner sidesteps. |
| KNOWLEDGE | **Analyze:** Winner moves to any space adjacent to Loser. |
| LOGIC | **Calculated:** Deal Minor HP Damage (Grazing hit). |
| AWARENESS | **Spot:** Loser gains Slowed status. |
| INTUITION | **Hazard:** Push Loser into nearest Obstacle/Ally (Damage + Stagger). |
| CHARM | **Feint:** Winner sidesteps; Loser stumbles forward 2 spaces. |
| WILLPOWER | **Dominate:** Winner gains Advantage on next action vs Loser. |

---

## II. WORLD GENERATION (The Scene Stack)

Quests are not static maps. They are procedural "Decks" of scenes generated by `world_engine.py`.

### 1. The Quest Template

Every Quest is generated as a stack of cards:

```
Scene Block A: 1d4 Random Minor Scenes (Rooms/Corridors).
PLOT POINT 1: Major Narrative Event (Mini-boss, Puzzle, Discovery).
Scene Block B: 1d4 Random Minor Scenes.
PLOT POINT 2: The Twist (Major Narrative Shift).
Scene Block C: 1d4 Random Minor Scenes.
FINALE: The Boss / Goal.
```

### 2. Card Flipping

- **Advance:** Entering a room "Flips" the top card.
- **Auto-Event:** Every flipped card automatically draws an Encounter Card (Combat, Trap, Hazard, or Empty).

---

## III. TENSION & CHAOS (The Clock)

This system punishes loitering and drives the pace.

### 1. The Chaos Die (1d10)

- Rolled once at the start of the Quest.
- **Result = Chaos Level** (e.g., 7).
- This number is the "Target" for Chaos Events and Channeling.

### 2. The Tension Die (1d10)

**Trigger:** Rolled whenever the party takes a "Slow Action" (Resting, Searching, Patching Wounds).

**Mechanic:**

| Roll | Result |
|------|--------|
| **1 - X** | **EVENT TRIGGERS.** (X starts at 1, increases on safe rolls). Spawns wandering monster/hazard. Tension Threshold X resets to 1. |
| **== Chaos Level** | **CHAOS EVENT!** Trigger Event + Chaos Modifier. Reroll Chaos Die (New Level) AND Add Tick to Chaos Clock. |
| **Safe Roll** | No Event. Increase Tension Threshold by 1. (Dungeon gets more dangerous the longer you stay quiet.) |

### 3. The Chaos Clock

- **Fills via:** Chaos Events or Channeling Failures.
- **Full Clock = DOOM STATE:**
  - The Dungeon actively hates you.
  - Every Scene Card flip includes a Chaos Modifier.
  - Tension Die triggers on 1-5 automatically.

---

## IV. CHANNELING CHAOS (The Nuclear Option)

Players can tap into raw entropy to force a result.

**Action:** Declare a Target. Roll 1d10.

| Roll Result | The Outcome |
|-------------|-------------|
| **Matches Chaos Level** | **PERFECT:** It works. Target is Hit + Random Chaos Effect. |
| **Miss by 1-2** | **BACKFIRE:** You take Damage. Effect redirects to closest entity (Friend or Foe). |
| **Miss by 3+** | **WILD:** Effect redirects to random target between You and Farthest Entity. |
| **Critical Fail (1)** | **MELTDOWN:** Chain Reaction. You Hit → Nearest Hit → Next-Nearest Saves (10%) or Hit. +1 Chaos Modifier. |

**Cost:** Every attempt adds 1 Tick to the Chaos Clock.

---

## V. AI NARRATION (The Flavor)

The AI acts as the "Sensory Layer" over the Engine's "Physics Layer."

- **No Static Flavor Text:** We do not write "You see a goblin."
- **Contextual Generation:**
  - Input: `[Biome: Sump], [Event: Trap], [Damage: Acid]`
  - Output: *"The rot-wood floorboards snap. Green, hissing bile sprays from a pressurized pod beneath the mud, melting your boots."*
- **Dynamic Details:** If Chaos Clock is high, AI shifts descriptions to be more oppressive, dark, and surreal.

---

## VI. TECHNICAL ARCHITECTURE

The project is built as independent modules that feed into `main.py`.

### 1. foundry.py (The Compiler)
- **Status:** ACTIVE (V3).
- **Job:** Ingests CSVs → outputs `chaos_core.json`.
- **Next Step:** Ensure Events.csv is ingested to populate the Scene Stack.

### 2. world_engine.py (The Director)
- Generates the SceneStack list.
- Manages the ChaosManager (Level, Clock, Tension Die).
- Returns current "Room State" to the visualizer.

### 3. combat_engine.py (The Physicist)
- Calculates Attack vs Defense margins.
- Resolves The Clash logic (Stat comparisons).
- Resolves Channeling logic (Target redirects).

### 4. char_engine.py (The Actor)
- Calculates derived stats.
- Manages Loadout (Max Stamina = Base - Gear Cost).
- Checks Talent prerequisites against Skill Ranks.

### 5. main.py (The Visualizer)
- Draws the Grid/Map.
- Draws the HUD (HP, Tension Die, Chaos Clock).
- Feeds user input to the Engines.

---

## Implementation Roadmap

1. **Generate `world_engine.py`:** Implement the Stack, Tension, and Chaos mechanics.
2. **Generate `combat_engine.py`:** Implement the new Clash and Channeling math.
3. **Generate `char_engine.py`:** Implement the Stat/Loadout logic.
4. **Update `main.py`:** Connect them all into the playable loop.
